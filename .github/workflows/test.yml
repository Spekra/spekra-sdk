name: Test

on:
  workflow_call:
    inputs:
      node-versions:
        description: 'JSON array of Node.js versions to test'
        type: string
        default: '["22"]'
      playwright-versions:
        description: 'JSON array of Playwright versions to test'
        type: string
        default: '["1.48"]'
      jest-versions:
        description: 'JSON array of Jest versions to test'
        type: string
        default: '["29"]'
      run-fixtures:
        description: 'Whether to run fixture tests'
        type: boolean
        default: false

jobs:
  # Core package tests (shared utilities)
  core-tests:
    name: Core Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build core
        run: pnpm --filter @spekra/core build

      - name: Test core
        run: pnpm --filter @spekra/core test

      - name: Typecheck core
        run: pnpm --filter @spekra/core typecheck

  # Playwright reporter tests
  playwright-tests:
    name: Playwright Tests (Node ${{ matrix.node }})
    needs: core-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm --filter @spekra/core --filter @spekra/playwright build

      - name: Typecheck
        run: pnpm --filter @spekra/playwright typecheck

      - name: Typecheck tests
        run: pnpm --filter @spekra/playwright typecheck:tests

      - name: Lint
        run: pnpm --filter @spekra/playwright lint

      - name: Start Prism mock server
        working-directory: packages/playwright
        run: |
          npx @stoplight/prism-cli mock openapi.json --port 4010 --host 127.0.0.1 &
          # Wait for Prism to be ready
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4010/api/reports > /dev/null 2>&1; then
              echo "Prism is ready"
              break
            fi
            sleep 0.5
          done

      - name: Test with coverage
        run: pnpm --filter @spekra/playwright test:coverage

      - name: Check bundle size
        run: pnpm --filter @spekra/playwright size

      - name: Upload coverage to Codecov
        if: matrix.node == '22'
        uses: codecov/codecov-action@v4
        with:
          files: packages/playwright/coverage/lcov.info
          flags: playwright
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Jest reporter tests
  jest-tests:
    name: Jest Tests (Node ${{ matrix.node }})
    needs: core-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm --filter @spekra/core --filter @spekra/jest build

      - name: Typecheck
        run: pnpm --filter @spekra/jest typecheck

      - name: Lint
        run: pnpm --filter @spekra/jest lint

      - name: Test
        run: pnpm --filter @spekra/jest test

      - name: Check bundle size
        run: pnpm --filter @spekra/jest size

  # Playwright fixture tests (full matrix)
  playwright-fixtures:
    name: PW Fixtures (Node ${{ matrix.node }}, PW ${{ matrix.playwright }})
    if: inputs.run-fixtures
    needs: playwright-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
        playwright: ${{ fromJson(inputs.playwright-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build @spekra/playwright
        run: pnpm --filter @spekra/core --filter @spekra/playwright build

      - name: Install fixture dependencies
        working-directory: packages/test-fixtures/playwright-${{ matrix.playwright }}
        run: |
          # Override Playwright version for this fixture
          pnpm add -D @playwright/test@${{ matrix.playwright }}
          pnpm exec playwright install chromium

      - name: Run fixture tests
        working-directory: packages/test-fixtures/playwright-${{ matrix.playwright }}
        run: pnpm test
        env:
          SPEKRA_API_KEY: test-fixture-key
          SPEKRA_API_URL: http://localhost:3000/api/reports

  # Jest fixture tests (full matrix)
  jest-fixtures:
    name: Jest Fixtures (Node ${{ matrix.node }}, Jest ${{ matrix.jest }})
    if: inputs.run-fixtures
    needs: jest-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
        jest: ${{ fromJson(inputs.jest-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build @spekra/jest
        run: pnpm --filter @spekra/core --filter @spekra/jest build

      - name: Install fixture dependencies
        working-directory: packages/test-fixtures/jest-${{ matrix.jest }}
        run: |
          # Override Jest version for this fixture
          pnpm add -D jest@${{ matrix.jest }} @types/jest@${{ matrix.jest }} ts-jest@${{ matrix.jest }}

      - name: Run fixture tests
        working-directory: packages/test-fixtures/jest-${{ matrix.jest }}
        run: pnpm test
        env:
          SPEKRA_API_KEY: test-fixture-key
          SPEKRA_API_URL: http://localhost:3000/api/reports
