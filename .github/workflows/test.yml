name: Test

on:
  workflow_call:
    inputs:
      node-versions:
        description: 'JSON array of Node.js versions to test'
        type: string
        default: '["22"]'
      playwright-versions:
        description: 'JSON array of Playwright versions to test'
        type: string
        default: '["1.48"]'
      run-fixtures:
        description: 'Whether to run Playwright fixture tests'
        type: boolean
        default: false

jobs:
  unit-and-integration:
    name: Test (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm typecheck

      - name: Typecheck tests
        run: pnpm typecheck:tests

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

      - name: Start Prism mock server
        working-directory: packages/playwright
        run: |
          npx @stoplight/prism-cli mock openapi.json --port 4010 --host 127.0.0.1 &
          # Wait for Prism to be ready
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4010/api/reports > /dev/null 2>&1; then
              echo "Prism is ready"
              break
            fi
            sleep 0.5
          done

      - name: Test with coverage
        run: pnpm --filter @spekra/playwright test:coverage

      - name: Upload coverage to Codecov
        if: matrix.node == '22'
        uses: codecov/codecov-action@v4
        with:
          files: packages/playwright/coverage/lcov.info
          flags: playwright
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  playwright-fixtures:
    name: Fixtures (Node ${{ matrix.node }}, PW ${{ matrix.playwright }})
    if: inputs.run-fixtures
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJson(inputs.node-versions) }}
        playwright: ${{ fromJson(inputs.playwright-versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build @spekra/playwright
        run: pnpm --filter @spekra/playwright build

      - name: Install fixture dependencies
        working-directory: packages/test-fixtures/playwright-${{ matrix.playwright }}
        run: |
          # Override Playwright version for this fixture
          pnpm add -D @playwright/test@${{ matrix.playwright }}
          pnpm exec playwright install chromium

      - name: Run fixture tests
        working-directory: packages/test-fixtures/playwright-${{ matrix.playwright }}
        run: pnpm test
        env:
          SPEKRA_API_KEY: test-fixture-key
          SPEKRA_API_URL: http://localhost:3000/api/reports
          # Mock server would be started here in a real setup
